# 微程序控制器

# 计算机组成原理笔记：微程序控制器 (Microprogrammed Control)

## 一、 微程序控制的核心思想

微程序控制的设计理念是**仿照“程序设计”的方式**来实现硬件的控制逻辑。它将复杂的硬件控制逻辑软件化，把操作控制信号的产生变成了“读存储器”的操作。

### 1. 基本设计思路

1. **编码（微指令化）：**  将指令集中每一条机器指令执行所需的**相关控制信号**，按照一定的规则编码成**微指令**。
2. **编写（微程序化）：**  使用相关的微指令，为每一条机器指令编写一段相对应的**微程序**。

    - **核心对应关系：**  1条机器指令 = 1段微程序。
    - **构成：**  1段微程序由若干条微指令序列构成。
3. **存储（控制存储器）：**  将所有指令对应的微程序全部存放在一个只读存储器（ROM）中。

    - 这个存储器位于CPU内部，称为**控制存储器（Control Memory, CM/CS）** ，简称**控存**。

---

## 二、 关键概念的层级与关系 (考研重点)

理解微程序控制器，必须理清以下概念的从属关系（由大到小）：

1. **机器指令 (Machine Instruction)**

    - 程序员视角的指令，如 `lw`​, `add`​, `jmp`​。
    - 一条机器指令的功能由一段**微程序**来实现。
2. **微程序 (Microprogram)**

    - 对应一条机器指令的执行全过程。
    - 由若干条**微指令**序列组成。
3. **微指令 (Microinstruction)**

    - 对应**一个时钟周期（节拍）** 内的控制动作。
    - 一条微指令包含若干个**微命令**（控制信号）。
    - 微指令通常保存在控制存储器的一个单元中。
4. **微命令与微操作**

    - **微命令 (Micro-command)：**  控制部件向执行部件发出的控制信号（如 `PC_out`​, `MAR_in`​）。是**控制信号**。
    - **微操作 (Micro-operation)：**  执行部件在微命令控制下进行的实际操作（如 `PC -> Bus`​）。是**执行动作**。
    - **关系：**  微命令是因，微操作是果。

> **总结公式：**   
> 1条机器指令 -> 1个微程序 -> 若干微指令 -> (每条微指令) 若干微命令 -> 若干微操作

---

## 三、 举例分析：lw 指令的微程序执行过程

以 `lw`​ 指令（Load Word，取数指令）为例，其功能为 `R[rt] <- M[ R[rs] + SignExt(imm) ]`​。以下展示其在微程序控制器中的执行流。

### 1. 整体流程

​`lw`​ 指令的周期被划分为三个阶段，每个阶段包含若干时钟周期（节拍 $T$）：

- **取指周期：**  从内存取指令。
- **计算周期：**  计算操作数的有效地址。
- **执行周期：**  访问内存读取数据并写入寄存器。

### 2. 详细执行步骤（微指令视角）

每一列代表一个**时钟周期（节拍）** ，也就是一条**微指令**。

#### **阶段一：取指周期**

- **节拍 T1：**

  - **执行操作：**  $PC \to MAR$, $PC \to X$ (X为暂存器)
  - **控制信号（微命令）：**  $PC_{out}=1, MAR_{in}=1, X_{in}=1$
  - **微指令含义：**  将PC的内容送入地址寄存器MAR，同时送入ALU输入端X备份。
- **节拍 T2：**

  - **执行操作：**  $M[MAR] \to MDR$, $X+4 \to Z$
  - **控制信号：**  $Mem_R=1, MDR\_E=1, +4=1$
  - **微指令含义：**  读内存，指令送入MDR；同时PC+4送入暂存器Z。
- **节拍 T3：**

  - **执行操作：**  $Z \to PC$
  - **控制信号：**  $Z_{out}=1, PC_{in}=1$
  - **微指令含义：**  更新PC值指向下一条指令。
- **节拍 T4：**

  - **执行操作：**  $MDR \to IR$
  - **控制信号：**  $MDR_{out}=1, IR_{in}=1$
  - **微指令含义：**  将指令从MDR送入指令寄存器IR（至此，控制器获得了当前要执行的指令）。

#### **阶段二：计算周期（计算有效地址）**

- **节拍 T1：**

  - **执行操作：**  $R[rs] \to X$
  - **控制信号：**  $R_{out}=1, X_{in}=1$
  - **微指令含义：**  将基址寄存器值送入ALU输入端。
- **节拍 T2：**

  - **执行操作：**  $IR(I) + X \to Z$
  - **控制信号：**  $IR_{out}=1, ADD=1$
  - **微指令含义：**  将立即数偏移量与基址相加，结果存入Z（这是计算出的内存物理地址）。

#### **阶段三：执行周期**

- **节拍 T1：**

  - **执行操作：**  $Z \to MAR$
  - **控制信号：**  $Z_{out}=1, MAR_{in}=1$
  - **微指令含义：**  将有效地址送入MAR。
- **节拍 T2：**

  - **执行操作：**  $M[MAR] \to MDR$
  - **控制信号：**  $Mem_R=1, MDR\_E=1$
  - **微指令含义：**  读内存，数据送入MDR。
- **节拍 T3：**

  - **执行操作：**  $MDR \to R[rt]$
  - **控制信号：**  $MDR_{out}=1, R_{in}=1$
  - **微指令含义：**  将数据写回目标寄存器。

### 3. 映射关系

- 上述 **T1**​**<sub>T4 (取指) + T1</sub>**​**T2 (计算) + T1~T3 (执行)**  共9个节拍。
- 这9个节拍对应 **9条微指令**。
- 这9条微指令的集合，构成了 **​`lw`​**​ **指令的微程序**。
- 这个微程序存储在CPU内部的 **控制存储器** 中。

---

## 四、 考研易混淆点辨析

|比较项目|主存储器 (Main Memory)|控制存储器 (Control Memory)|
| :---------| :--------------------------| :------------------------------------|
|**位置**|CPU 外部 (主板上)|CPU 内部 (控制器内)|
|**存储内容**|机器指令和数据 (程序)|微指令 (微程序)|
|**性质**|RAM (可读写)|通常是 ROM (只读)|
|**寻址方式**|此时 PC (程序计数器) 指向|此时 CMAR (控存地址寄存器/uPC) 指向|
|**输出寄存器**|IR (指令寄存器) / MDR|CMDR (控存数据寄存器/uIR)|

## 五、 总结

- **微程序控制器**通过**存储逻辑**实现控制，规避了硬布线控制器复杂的组合逻辑电路设计。
- **优点：**  设计规整、灵活性强、易于修改和扩充指令系统（只需修改ROM中的微程序）。
- **缺点：**  速度通常比硬布线控制器慢（因为多了一级从控存读取微指令的操作）。
